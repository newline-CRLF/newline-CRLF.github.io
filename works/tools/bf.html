<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>高速 Brainfuck インタプリタ</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; display: flex; flex-direction: column; gap: 1rem; }
    textarea, pre { width: 100%; box-sizing: border-box; font-family: monospace; font-size: 1rem; padding: 0.5rem; }
    textarea { height: 150px; resize: vertical; }
    #controls { display: flex; gap: 0.5rem; }
    button { padding: 0.5rem 1rem; cursor: pointer; border: none; border-radius: 0.5rem; background: #4A90E2; color: white; }
    button:hover { background: #357ABD; }
    pre { background: #f4f4f4; min-height: 100px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>高速 Brainfuck インタプリタ</h1>
  <label>コード:</label>
  <textarea id="code" placeholder="Brainfuck コードをここに貼り付け"></textarea>
  <label>入力 (オプション):</label>
  <textarea id="input" placeholder=", コマンド用の入力"></textarea>
  <div id="controls">
    <button id="run">実行</button>
    <button id="reset">リセット</button>
  </div>
  <label>出力:</label>
  <pre id="output"></pre>

  <script>
    // テープサイズと初期化
    const TAPE_SIZE = 30000;
    let tape, ptr;

    function init() {
      tape = new Uint8Array(TAPE_SIZE);
      ptr = 0;
      document.getElementById('output').textContent = '';
    }

    // 括弧対応解析
    function buildBracketMap(code) {
      const map = new Map();
      const stack = [];
      for (let i = 0; i < code.length; i++) {
        const c = code[i];
        if (c === '[') stack.push(i);
        if (c === ']') {
          const start = stack.pop();
          map.set(start, i);
          map.set(i, start);
        }
      }
      return map;
    }

    // 実行
    function runBrainfuck(code, inputStr) {
      const outputElem = document.getElementById('output');
      const bracketMap = buildBracketMap(code);
      let inputPtr = 0;
      let output = '';
      for (let pc = 0; pc < code.length; pc++) {
        switch (code[pc]) {
          case '>': ptr = (ptr + 1) % TAPE_SIZE; break;
          case '<': ptr = (ptr - 1 + TAPE_SIZE) % TAPE_SIZE; break;
          case '+': tape[ptr] = (tape[ptr] + 1) & 0xFF; break;
          case '-': tape[ptr] = (tape[ptr] - 1 + 256) & 0xFF; break;
          case '.': output += String.fromCharCode(tape[ptr]); break;
          case ',': tape[ptr] = inputPtr < inputStr.length ? inputStr.charCodeAt(inputPtr++) : 0; break;
          case '[':
            if (tape[ptr] === 0) pc = bracketMap.get(pc);
            break;
          case ']':
            if (tape[ptr] !== 0) pc = bracketMap.get(pc);
            break;
        }
      }
      outputElem.textContent = output;
    }

    // イベント
    document.getElementById('run').addEventListener('click', () => {
      init();
      const code = document.getElementById('code').value.replace(/[^\[\]<>+\-.,]/g, '');
      const input = document.getElementById('input').value;
      runBrainfuck(code, input);
    });

    document.getElementById('reset').addEventListener('click', () => {
      init();
      document.getElementById('code').value = '';
      document.getElementById('input').value = '';
    });

    // 初期化
    init();
  </script>
</body>
</html>
